# ðŸ‰ DRACONIA CHRONICLES â€” v2.3.1 GAME DESIGN DOCUMENT

**Version:** 2.3.1
**Date:** 2025-01-15
**Status:** Comprehensive Technical Specification
**Canonical Precedence:** v2.2 GDD content integrated with Arcana Expansion v2.3.1

---

## Executive Summary

### ðŸŽ¯ **What This Document Does**

**For Non-Coders:** This is the complete "bible" for Draconia Chronicles - a dragon-themed idle game where players journey through different areas, fight enemies, and build up their dragon's power. The game combines automatic combat with strategic progression, where players can upgrade their dragon permanently while also getting temporary boosts during each adventure. Version 2.3.1 introduces a major change: instead of losing all your magical currency (Arcana) when returning home, you now keep most of it but pay a small tax to help protect the city.

**Technical Summary:** This v2.3.1 GDD represents the ultimate technical bible for Draconia Chronicles, consolidating all design decisions, technical specifications, and implementation details into a comprehensive reference. It builds upon the v2.0 foundation and integrates v2.1 refinements while establishing the complete vision for the shooter-idle experience with persistent Arcana progression.

### ðŸ—ï¸ **What We'll Have Completed After This GDD**

**For Non-Coders:** This document provides the complete blueprint for building Draconia Chronicles, including all the game mechanics, technical systems, and player progression features. It serves as the single source of truth for developers, designers, and stakeholders to understand exactly how the game works and what needs to be built.

**Technical Summary:** Complete technical specification covering core gameplay loops, economy systems, technical architecture, performance requirements, testing frameworks, and implementation details for all game systems.

### Key Integration Points

- **v2.0 Foundation:** Core shooter-idle loop, technical architecture, performance budgets

- **v2.1 Refinements:** UI/UX updates, enchant system redesign, currency layout

- **v2.2 Content:** Complete tech trees, region specifications, premium currency system

- **v2.3.1 Arcana Expansion:** Persistent Arcana system, Shield Tax, city investments, transmutation

- **Engineering Docs:** CI/CD procedures, testing frameworks, development workflows

---

## Table of Contents

### Core Design

1. [Vision, Lore & North Star](#1-vision-lore--north-star)

1. [Player Experience Overview](#2-player-experience-overview)

1. [Shooter-Idle Core Loop](#3-shooter-idle-core-loop)

1. [Progression: Maps, Wards & Lands](#4-progression-maps-wards--lands)

1. [Combat Systems, Enemies & Bosses](#5-combat-systems-enemies--bosses)

### Systems & Mechanics

1. [Abilities, Skills & Rituals](#6-abilities-skills--rituals)

1. [Economy: Currencies, Items, Market](#7-economy-currencies-items-market)

1. [Town, Lair & City Public Works](#8-town-lair--city-public-works)

1. [Automation: Roads, Convoys & Stewards](#9-automation-roads-convoys--stewards)

1. [Endgame: Rift Siege & NG+](#10-endgame-rift-siege--ng)

### Technical Architecture

1. [Frontend Architecture](#11-frontend-architecture)

1. [Simulation: Workers & Protocol](#12-simulation-workers--protocol)

1. [Rendering & Performance Budgets](#13-rendering--performance-budgets)

1. [Persistence: Dexie Save Schema](#14-persistence-dexie-save-schema)

1. [Telemetry, Stats & Analytics](#15-telemetry-stats--analytics)

### Content & Balance

1. [Firecraft, Safety & Scales Tech Trees](#16-firecraft-safety--scales-tech-trees)

1. [Balancing: Math, Curves & Tables](#17-balancing-math-curves--tables)

1. [Region R01: Horizon Steppe](#18-region-r01-horizon-steppe)

1. [Premium Currency: Astral Seals](#19-premium-currency-astral-seals)

### Quality & Development

1. [Testing, QA & CI/CD](#20-testing-qa--cicd)

1. [Accessibility & Mobile UX](#21-accessibility--mobile-ux)

1. [Roadmap: Phases, Epics & Workpacks](#22-roadmap-phases-epics--workpacks)

1. [Security, Privacy & Legal](#23-security-privacy--legal)

---

## 1. Vision, Lore & North Star

### Player Promise

> "Push forward, overcome waves, **return to Draconia to invest**, then surge farther."

### Core Fantasy

Defend the Dragonlands from encroaching evil..
Traverse Wards within Lands, defeat enemies, gather **Arcana**, and invest in temporary
**Enchants**
to
push
farther.
Return to Draconia to bank progress, buy upgrades, and expand the city.

### North Star Constraints

- **Pre-Rift combat power:** â‰¥70% Journey research; town/meta â‰¤30% (City â‰¤10%)

- **Performance:** 60 fps desktop; â‰¥40 fps mid-phones; â‰¤200/400 enemies; â‰¤600 projectiles/s

- **Offline:** 8h linear â†’ decaying; cap 24h; META â†’ 96h; **Rested +50%/15m; 30m cd**

- **Persistence:** 3 profiles (META â†’ 6); Dexie v1; export/import

- **Privacy:** no PII beyond dragon name; logs/stats exportable NDJSON

### Lore Canon

- **Draconia, Last Bastion** â€” refugees, overtaxed city, arcane shield

- **Dragonlands** â€” Lands/Wards as regions of encroaching chaos

- **The Human-wrought Evil** â€” unleashed force spilling into Dragonlands

- **The Council & Shield** â€” fiction for Arcana donation on Return

### Inspirations

- **Unnamed Space Idle** (primary), Cookie Clicker, Rusty's Retirement

---

## 2. Player Experience Overview

### First Session (0â€“10 min)

- Splash â†’ Name Dragon â†’ Welcome â†’ **Begin Journey** (no blockers)

- Minimal tutorial: distance ticks; enemies spawn; Arcana drops; **Return** hint

### First Hour (10â€“60 min)

- Enchants: Firepower/Scales (geometric Ã—1.12), Tier-Up (15â€“25Ã— last)

- First boss; 2â€“3 returns/hour target; micro-ramps visible

### Daily Rhythm

- Offline report, applied gains (8h linear â†’ diminishing up to 24h; META â†’ 96h)

- **Rested** +50% for 15 min; cooldown 30 min playtime

### Device UX

- **Desktop:** multi-pane (Journey, Logs, Tabs)

- **Mobile:** bottom sheets, FAB, 44Ã—44 targets, reduced motion

---

## 3. Shooter-Idle Core Loop

### Loop Diagram

```mermaid

flowchart LR
    Start[Begin Journey] --> Fight[Auto-combat & Ability-1]
    Fight -->|Arcana| Return[Return to Draconia]
    Return --> Tax[Shield Tax 25%]
    Tax --> Spend[Spend on Enchants/City]
    Spend --> Start

```text

### Core Systems

**Distance:** meters tick, micro-ramps (5m early, 10m later)

**Spawns & AI:** approach, stop-at-range; two families baseline

**Dragon Combat:** base weapon(s), hit/crit, TTK smoothing

**Arcana:** drops â†’ persistent currency; spent on Enchants (DMG/HP) Ã—1.12; Tier-Up 15â€“25Ã—

**Return:** Shield Tax (25% of total Arcana); temporary enchants reset; permanent starting levels persist; Arcana persists; meta persists where specified

**Offline:** 8h linear â†’ diminishing; 24h cap; META â†’ 96h; Rested +50%/15m

### TypeScript Implementation Stubs

```typescript

// What this does: Calculates the geometric cost progression for enchant upgrades
// Why this exists: Provides smooth, predictable cost scaling that prevents runaway
inflation
// How it integrates: Used by enchant system to determine upgrade costs
// Usage context: Called when player attempts to upgrade enchants during journey
export function costGeom(base: number, lvl: number, r = 1.12) {
  // base: starting cost for level 0
  // lvl: current level to calculate cost for
  // r: geometric ratio (default 1.12 = 12% increase per level)
return Math.floor(base * Math.pow(r, lvl)); // Apply geometric progression and round down
}

// What this does: Calculates the difficulty multiplier when entering a new ward
// Why this exists: Provides significant difficulty jumps between areas to maintain
challenge
// How it integrates: Used by enemy scaling system to increase stats when advancing wards
// Usage context: Called when player crosses ward boundaries during journey
export function wardBump(ward: number, mult = 1, bump = 1.22) {
  // ward: current ward number (1, 2, 3, etc.)
  // mult: base multiplier (usually 1.0)
  // bump: ward difficulty increase factor (default 1.22 = 22% increase per ward)
  return mult * Math.pow(bump, ward - 1); // Apply ward-based difficulty scaling
}

// What this does: Calculates enemy difficulty micro-ramps within a ward based on distance
// Why this exists: Provides gradual difficulty increase to maintain engagement without
sudden
jumps
// How it integrates: Used by enemy spawning system to scale individual enemy stats
// Usage context: Called continuously during journey to update enemy difficulty
export function microRamp(distM: number, stepM: number, inc = 0.01) {
  // distM: current distance traveled in meters
  // stepM: distance interval for each micro-ramp (e.g., every 5 meters)
  // inc: difficulty increase per step (default 0.01 = 1% increase)
  return 1 + Math.floor(distM / stepM) * inc; // Calculate total difficulty multiplier
}

```text

### Telemetry (Phase 1)

- `screen*view`, `journey*start/end`, `return*to*draconia`, `upgrade_purchase`

- `death`, `ability*used`, `offline*return`, `fps`

- **v2.3.1 Arcana Events:** `shield*tax*paid`, `arcana*deposited`, `transmutation*attempt`, `city*donation`, `barrier*power_invested`

---

## 4. Progression: Maps, Wards & Lands

### Structure

World â†’ Lands â†’ Wards â†’ distance milestones..
Each Ward: micro-ramps and a gate (boss/mini-boss).

### Data Model

```typescript

export interface Land {
  id: number;
  name: string;
  wards: Ward[];
}

export interface Ward {
  id: number;
  name: string;
  distStepM: number;
  bump: number;
  bossId?: number;
}

```text

### Content Plan (Chapter 1 slice)

- **Lands:** 1â€“3 for MVP; each with ~10 Wards; miniboss every 5, boss every 10

- **Drops:** Arcana always; items (sell for Gold) occasionally; rare **Scrolls** (seed future moves)

- **Bosses:** elemental variants with simple ability pool; guaranteed chest on first clear

---

## 5. Combat Systems, Enemies & Bosses

### Enemy Archetypes

- **Swarm** (low HP, high count), **Ranged** (projectiles), **Shielded** (damage gates)

- **Spectral** (phase), **Chitin** (armor breakpoint)

### Boss Design

- Telegraph windows ("use ability now"), attempt/clear metrics, retreat rules

### Stats & Curves

```typescript

export interface EnemyFamily {
  id: number;
  baseHP: number;
  baseDMG: number;
  traits: string[];
}

export function enemyHP(base: number, ward: number, distM: number, bump = 1.18) {
  return Math.floor(base * Math.pow(bump, ward - 1));
}

```text

### Scaling & Cadence

- **HP:** `HP(n) = baseHP * 1.12^n` (normal), elites/bosses apply multipliers

- **DMG:** `DMG(n) = baseDMG * 1.10^n`

- **Ward bump:** step increase on entering each Ward; **micro-ramps** inside Ward: +x% every 5m (early), 10m (later)

- **Caps:** design for **200 active enemies** (spikes **400**) and **â‰¤600 projectiles/s**

---

## 6. Abilities, Skills & Rituals

### Ability Framework

```typescript

export type AbilityId = number;

export interface AbilitySpec {
  id: AbilityId;
  name: string;
  cdMs: number;
  kind: 'burst' | 'dot' | 'utility';
}

export interface BuffSpec {
  id: number;
  durationMs: number;
  mods: {
    dmgMult?: number;
    aspd?: number;
  };
}

```text

### Manual Abilities ("moves")

- Tap-to-cast skills with **charges (PP)**/cooldowns; early examples: **Breath Burst**, **Wing Guard**, **Time Slip**

- Power-ups can grant temporary **infinite PP** windows for engagement spikes

### Manual Contribution Target

~20% Â±10% pre-Rift damage from abilities

### Scrolls & Rituals

- Drops per Land; dupes â†’ Scribe Ink; pity + targeted scribing

- Skills tree (smithing, mining) scaffolding (post-MVP hooks)

---

## 7. Economy: Currencies, Items, Market

### Currencies

- **Arcana** (persistent run currency), **Gold** (QoL), **Soul Power** (meta), **Astral Seals** (premium)

### Arcana Expansion (v2.3.1)

Arcana is now **persistent** across journeys and serves multiple purposes beyond temporary
enchants:

#### City of Draconia Investments

- **Civic Donations:** Contribute Arcana to expand housing, civic spires, and public works â†’ grants permanent buffs (e.g., global +2% Arcana yield, faster lab research)

- **Barrier Power:** Direct Arcana into the Great Barrier â†’ lore integration, occasional region events where player donations strengthen defenses

- **Guild/Apprentice Housing:** Unlock junior dragons, alchemists, or apprentices via Arcana-funded construction

#### Economy & Crafting

- **Synth Boosts:** Arcana temporarily accelerates Synth production, increases yield, or removes input costs for one cycle

- **Arcana Infusion:** Enchant crafted gear with temporary magical bonuses (e.g., "Arcana-forged Blade: +5% DMG for 1h")

- **Transmutation (Alchemist NPC):**

  - Combine Gold + Arcana â†’ attempt to transform into rarer minerals (White Gold, Platinum, Azure/Black/Royal Platinum)

  - **Risk Factor:** chance of failure where Gold is consumed with no output. Higher Arcana input reduces risk but never removes it

  - **Design Goal:** Gambling-like tension balanced with meaningful long-term gains

#### Arcana Shield Bank

A dedicated **Arcana dumping system** for surplus currency:

- **Mechanic:** Players deposit Arcana into the Shield Bank. Deposits are permanent; withdrawn Arcana is not possible

- **Milestone Rewards:** Secrets/powers unlocked at specific thresholds:

  - 1,000, 10,000, 250,000, 500,000, 1,000,000, 5,000,000, 10,000,000, 50,000,000, 250,000,000, 500,000,000 Arcana

  - (future milestones scale upward indefinitely)

- **Reward Philosophy:** Secrets TBD; may include unique powers, boosts, transformations, or major progression accelerators. Rewards should feel monumental and lore-significant

### Shield Tax System

To discourage journey spamming, Draconia levies a tax on dragons returning for shield
protection:

- **Base Tax:** 25% of total Arcana

- **Lore:** "These are the end times" - the tax is steep but necessary for the city's survival

- **Legendary Dragons:** Higher legendary status increases chance of tax reduction

- **Player Hint:** System tells players there are ways to reduce the tax, encouraging progression

### Item Model

```typescript

export enum Rarity {
  Common = 1,
  Uncommon = 2,
  Rare = 3,
  Epic = 4
}

export enum PriceBin {
  Low = 1,
  Fair = 2,
  High = 3
}

export interface Item {
  id: string;
  rarity: Rarity;
  baseVal: number;
}

```bash

### Market System

- **Taxed stalls** in early Market; open **owned shops** later to remove taxes at the cost of being "manned"

- **Hire clerks** (wage) for uptime; **Mercantile level** rises with sales, unlocking better margins/slots

- **City investments:** donate Arcana/Gold to expand housing and civic buildings for **permanent** global buffs

---

## 7.5. Arcana Expansion Implementation (v2.3.1)

### ðŸŽ¯ **What This Section Does**

**For Non-Coders:** This section explains how the new Arcana system works in detail. Instead of losing all your magical currency when returning home, you now keep most of it and can use it for many different things: investing in the city to make it stronger, trying to turn regular gold into rare materials (with some risk), and depositing extra Arcana into a special bank that unlocks powerful rewards. The system also includes a tax when you return to the city (25% of your total Arcana) to help protect the city, but legendary dragons can reduce this tax.

**Technical Summary:** Implementation details for the Arcana Expansion v2.3.1 system including frontend UI components, backend state management, economy balancing, and narrative integration for persistent Arcana currency with Shield Tax system.

### Frontend Implementation

- **Svelte UI Components:**

  - Shield Bank interface with deposit animations and milestone progress bars

  - Alchemist transmutation interface with risk/reward visualization

  - City investment panels showing donation options and permanent buff previews

  - Shield Tax notification system with legendary status hints

### Backend/State Management

- **Dexie Schema Extensions:**

  ```typescript

  // What this does: Defines the data structure for storing Arcana Expansion progress
// Why this exists: Allows players to save their city investments, transmutation history,
and
legendary
status
// How it integrates: Extends the main Profile schema to track persistent Arcana-related
progress
// Usage context: Saved to IndexedDB whenever player makes Arcana-related purchases or
investments
  export interface ArcanaExpansionData {
shieldBankDeposited: number; // Total Arcana deposited into Shield Bank (permanent)
cityDonations: Record<string, number>; // Track donations by type (housing, civic, etc.)
barrierPower: number; // Total Arcana invested in Great Barrier
transmutationHistory: TransmutationAttempt[]; // History of all transmutation attempts
legendaryStatus: number; // Player's legendary status (affects Shield Tax)
  }

  // What this does: Records a single attempt to transmute gold into rare materials
  // Why this exists: Allows tracking success rates and provides history for UI display
  // How it integrates: Stored in ArcanaExpansionData.transmutationHistory array
  // Usage context: Created each time player attempts transmutation at Alchemist NPC
  export interface TransmutationAttempt {
    id: string;           // Unique identifier for this attempt
    timestamp: number;    // When the attempt was made (epoch ms)
    goldInput: number;    // Amount of gold used in attempt
    arcanaInput: number;  // Amount of Arcana used to reduce risk
    success: boolean;     // Whether transmutation succeeded
    output?: string;      // Type of rare material produced (if successful)
  }

```bash

### Economy Balancing

- **Shield Bank Thresholds:** Set at "round milestones" (1K, 10K, 250K, etc.) for psychological impact

- **Transmutation Success Curve:** Tuned to avoid runaway rare mineral generation

- **Shield Tax Calculation:**

  ```typescript

// What this does: Calculates the Shield Tax amount based on total Arcana and legendary
status
// Why this exists: Provides fair taxation that rewards player progression while funding
city
protection
// How it integrates: Called by Return to Draconia system when processing return from
journey
// Usage context: Used during return flow to determine how much Arcana player keeps vs
pays
as
tax
  function calculateShieldTax(totalArcana: number, legendaryStatus: number): number {
    const baseTax = 0.25; // 25% base tax rate - standard rate for all dragons
const legendaryReduction = Math.min(legendaryStatus * 0.01, 0.15); // max 15% reduction
from
legendary
status
const effectiveTax = baseTax - legendaryReduction; // Final tax rate after legendary
reduction
return Math.floor(totalArcana * effectiveTax); // Calculate actual tax amount (rounded
down)
  }

```javascript

### Narrative Integration

- **Codex Secrets:** Tied to donation milestones, revealing lore about Draconia's history

- **Council NPC Dialogue:** Updates as global Barrier strengthens via Arcana donations

- **Legendary Status Progression:** Earned through major achievements, affects tax reduction chances

---

## 7.6. Enchantment System Architecture (v2.3.1)

### ðŸŽ¯ **What This Section Does** (2)

**For Non-Coders:** This section explains how the enchantment (power-up) system works in the game. There are two types of enchantments: temporary ones that you buy during a journey with Arcana (and lose when you return home), and permanent ones that you buy with Soul Power and keep forever. The permanent ones make every journey start stronger - for example, if you have +5 permanent Firepower, every journey starts at Firepower level 5 instead of 0. This means you don't have to repeat the same early-game progression over and over.

**Technical Summary:** Complete architecture for dual-layer enchantment system supporting both temporary journey-bound upgrades (reset on return) and permanent meta-progression upgrades (persist across journeys) with comprehensive data structures and lifecycle management.

### Dual-Layer Enchant System

The enchantment system supports both temporary and permanent progression:

#### Temporary Enchants (Journey-Bound)

- **Reset on Return:** All temporary enchant levels reset to starting levels

- **Arcana Cost:** Geometric progression (Ã—1.12) for each level

- **Purpose:** Provide immediate power for current journey

#### Permanent Starting Levels (Meta Progression)

- **Soul Power Purchase:** Permanent upgrades using Soul Power currency

- **Starting Level Boost:** Each journey begins at purchased starting level

- **Example:** +5 permanent Firepower means every journey starts at Firepower level 5

- **Purpose:** Provide long-term progression and reduce early-game repetition

### Implementation Architecture

```typescript

// What this does: Defines the complete data structure for the dual-layer enchantment
system
// Why this exists: Allows tracking both temporary journey upgrades and permanent
meta-progression
upgrades
// How it integrates: Used by enchant managers, UI systems, and save/load functionality
// Usage context: Created and maintained throughout the game lifecycle for all enchantment
operations
interface EnchantSystem {
  // Temporary journey levels - these reset to permanent levels when returning to Draconia
  // What this does: Tracks current journey-specific enchantment levels
// Why this exists: Allows players to temporarily boost power during journeys with Arcana
  // How it integrates: Modified during journey when spending Arcana, reset on return
  temporary: {
    firepower: number;  // Current Firepower level (0-45, or current tier maximum)
    scales: number;     // Current Scales level (0-45, or current tier maximum)
    tier: number;       // Current enchantment tier (1-N, affects level caps)
  };

// Permanent starting levels - these persist across all journeys and are purchased with
Soul
Power
  // What this does: Tracks permanent enchantment upgrades that affect starting levels
  // Why this exists: Provides long-term progression and reduces early-game repetition
// How it integrates: Modified when spending Soul Power, used to initialize temporary
levels
  permanent: {
firepower: number; // Permanent Firepower starting level (0-45, purchased with Soul Power)
scales: number; // Permanent Scales starting level (0-45, purchased with Soul Power)
    tier: number;       // Permanent tier level (1-N, purchased with Soul Power)
  };

  // Calculated effective levels - these are what actually affect gameplay
  // What this does: Combines temporary and permanent levels for actual game mechanics
  // Why this exists: Provides single source of truth for enchantment power calculations
  // How it integrates: Used by combat system, UI display, and damage calculations
  effective: {
    firepower: number;  // Total Firepower = temporary.firepower + permanent.firepower
    scales: number;     // Total Scales = temporary.scales + permanent.scales
    tier: number;       // Highest tier = max(temporary.tier, permanent.tier)
  };
}

```javascript

### Journey Lifecycle

1. **Journey Start:** Enchants initialize to permanent starting levels

1. **During Journey:** Arcana can be spent to increase temporary levels

1. **Journey End:** Temporary levels reset, permanent levels persist

1. **Meta Progression:** Soul Power can be spent to increase permanent starting levels

---

## 8. Town, Lair & City Public Works

### Lair v0

- Rooms: Nest, Workshop, Trophy Hall

- **Comfort â†’ Rested cap & regen** only (â‰¤5% DPS pre-Rift)

### City Public Works

- Pipeline: Gather â†’ Transport â†’ Refine â†’ Build â†’ Commission

- Bastion Tier raises **population/footfall** & hiring quality

- **Arcana Investments:** Donate Arcana to expand housing, civic spires, and public works for permanent global buffs

- **Barrier Integration:** Arcana donations strengthen Draconia's Great Shield, with occasional region events

### Safeguards

- Income caps at early tiers; slow unlocks ensure meta doesn't eclipse core combat before credits

- City bonuses â‰¤10% pre-Rift

---

## 9. Automation: Roads, Convoys & Stewards

### Systems

- Single route & Node; Guards; **Safety Index**

- Steward contracts (weaker dragons): scroll vs mats focus

- Incidents cause **downtime only** (no loot loss)

### Future Automation

- Assign junior dragons to Lands for passive searches (RNG mitigated with pity)

---

## 10. Endgame: Rift Siege & NG+

### Components

- Forward outposts (timed mini-projects)

- Siege gauntlet (phases; ability checks)

- NG+ mutators (resource attrition; elemental embargo weeks)

### Design Philosophy

- Clear achievable without deep town but juiced by good civic play

---

## 11. Frontend Architecture

### Stack

- **Platforms:** Desktop browsers (Chromium/Firefox/Edge), mobile browsers; installable PWA

- **Render:** **PixiJS** (WebGL) for combat scene; Svelte UI overlays

- **Sim:** **Web Workers** handle spawning, projectiles, DPS/HP math, and offline ticks

- **Persist:** **Dexie** (IndexedDB) with versioned schema, migrations, and integrity validation

- **PWA:** Workbox precache + update toast ("New version available â†’ Reload")

### Stores & Flags

```typescript

export interface AppFlags {
  hud: boolean;
  tlmVerbose: boolean;
}

export const appFlags = readable<AppFlags>({
  hud: false,
  tlmVerbose: false
});

```bash

### Routing

- `/` Splash, `/journey`, `/return`, `/town`, `/stats`

---

## 12. Simulation: Workers & Protocol

### Lifecycle

- FG: fixed **16.67ms**; BG: hidden â†’ **2 Hz** sim; resume FG gracefully

### Protocol v1

```typescript

// UI->Sim
type UIToSim =
  | { t: 'boot'; seed: number }
  | { t: 'start' }
  | { t: 'stop' }
  | { t: 'ability'; id: number }
  | { t: 'offline'; elapsedMs: number };

// Sim->UI
type SimToUI =
  | { t: 'ready' }
| { t: 'tick'; now: number; stats: { fps: number; enemies: number; proj: number; dps:
number
}
}
  | { t: 'log'; lvl: 'info' | 'warn' | 'error'; msg: string }
  | { t: 'fatal'; reason: string };

```bash

### Determinism

- RNG: xoroshiro/PCG streams per system (spawns/crits)

- Fixed timestep (16.67ms), offline stub, auto-recover

---

## 13. Rendering & Performance Budgets

### Pixi Mount

- Resize, DPR, ticker; pause rendering when hidden (sim continues in BG)

### Pooling & Culling

- Enemies/projectiles pooled; offscreen culled; pooled damage numbers/text

### Budgets

- 60 fps desktop; â‰¥40 fps mid-phones; â‰¤200/400 enemies; â‰¤600 proj/s

### Performance Targets

- **Frame time:** ~16.6ms desktop; target â‰¥25ms ceiling mid-phones

- **Entities:** 200 active (burst 400); projectiles â‰¤600/s

- **Bundles:** base app â‰¤ 200 KB gz; logger layer â‰¤ **8 KB gz**; defer heavy tools

- **Workers:** no layout work; isolate hot loops; avoid GC via pooling

---

## 14. Persistence: Dexie Save Schema

### Overview

IndexedDB via Dexie; Zod codecs; **double-buffer** atomic writes; backups; export/import

### Schema (V1)

```typescript

export interface SaveV1 {
  version: 1;
  profiles: Profile[];
  settings: { a11yReducedMotion: boolean };
}

export interface Profile {
  id: string;
  name: string;
  createdAt: number;
  lastActive: number;
  progress: { land: number; ward: number; distanceM: number };
  currencies: {
    arcana: number;
    gold: number;
    soulPower: number;
    astralSeals: number;
  };
  enchants: {
    firepower: number;
    scales: number;
    tier: number;
  };
  // v2.3.1 Permanent Enchant Starting Levels
  enchantStartingLevels: {
    firepower: number;  // Permanent starting level (purchased with Soul Power)
    scales: number;     // Permanent starting level (purchased with Soul Power)
    tier: number;       // Permanent starting tier (purchased with Soul Power)
  };
  stats: { playtimeS: number; deaths: number; totalDistanceM: number };
  leaderboard: { highestWard: number; fastestBossS: number };
  // v2.3.1 Arcana Expansion
  arcanaExpansion: {
    shieldBankDeposited: number;
    cityDonations: number;
    barrierPower: number;
    transmutationAttempts: number;
    transmutationSuccesses: number;
    legendaryStatus: number; // affects Shield Tax reduction chance
  };
}

```javascript

### Logger Design

```typescript

export type LogLevel = 'debug' | 'info' | 'warn' | 'error';
export type LogEvent = {
  t: number; // epoch ms
  lvl: LogLevel;
  src: 'ui' | 'worker' | 'render' | 'net';
  msg: string;
  data?: Record<string, unknown>;
  profileId?: string; // no PII beyond dragon name, unless user opts in
};

```text

### Caps & Persistence

- **Caps:** **2 MB or 10k entries**, whichever reached first; oldest-first eviction

- **Persistence:** Dexie store `logs` with rolling buffer; toggleable in dev/prod; export from UI

---

## 15. Telemetry, Stats & Analytics

### Package

`@draconia/telemetry`: Aggregator Worker; Dexie queues (cap 1â€“2 MB or 5k events); lifetime
&
daily
snapshots

### Event Schema

```typescript

export type Ev = {
  ts: number;
  v: 1;
  sid: string;
  cid: string;
  build: string;
  n: string;
  p?: Record<string, number | string | boolean>;
};

```javascript

### Stats Page

- Overview, Progression, Combat, Economy, Offline, Performance

- NDJSON Export; macro-events to Plausible/Fathom (opt-in)

### Privacy

- **Logging:** **Structured JSON** logs, persisted **ring buffer (cap 2 MB OR 10k entries)**, exportable JSON. No PII beyond dragon name unless user explicitly opts in

---

## 16. Firecraft, Safety & Scales Tech Trees

### Core Philosophy

**Discovery before Unlock:** Only **Ember Potency** and **Draconic Vitality** are visible at game start. **All other nodes** (Firecraft/Safety/Scales) are **hidden** by default and must be **discovered** in the Research Lab.

### Research States

`Unknown â†’ Discovered (via Research) â†’ Soul-Unlocked â†’ Arcana-Leveled`

### Fire Tiers & Global Risk

Tiers are **global states** that modify the breath's nature and **increase hazard**
(self-risk)..
They don't level; they **toggle on** when you meet triggers.

| Tier | Feel | Hazard Mult | Key Trigger |
|------|------|-------------|-------------|
| Regular | baseline | 1.00 | default |
| Blue | smokeless, piercing jets | 1.05 | Hydrideâ‰¥6 + Oxygenatorâ‰¥4 + Honeycombâ‰¥1 |
| Green | solvent/caustic DoT | 1.10 | Resinâ‰¥6 + Honeycombâ‰¥3 + Swirlâ‰¥3 |
| Purple | chain arcs + pulse staggers | 1.15 | Arc Organâ‰¥6 + Pulse Reactorâ‰¥3 + Variable
Swirlersâ‰¥2
|
| Dark | terror ticks / overburn nuance | 1.20 | Arc Organâ‰¥4 + Pulse Rate Tuning unlocked
+
Oxy-Shunt
unlocked
|
| Black | ink/smoke fields + stacking DoT | 1.25 | Napalm Fractionator + Dust Cyclone +
Preheaterâ‰¥4
|
| Holy | radiant vs..
corrupted; self-cleanse | 1.30 | Honeycombâ‰¥5 + Pilot Combâ‰¥4 + Oxy-Shunt unlocked |
| Azure | armor-piercing beam lance | 1.35 | (Blue) + Heaterâ‰¥5 + Jet Disciplineâ‰¥3 + Beam
patternâ‰¥3
|
| Prismatic | cross-style combo windows | 1.40 | Any 3 style modes + Dual Split-Beams |
| Void | apex glass-cannon annihilation | 1.50 | Combined depth of Black+Dark+Azure â‰¥ 24 |

### Currencies & Economy

- **Arcana (persistent):** earned per kill; **persists across journeys**; spent to level unlocked nodes during a journey; also used for city investments, transmutation, and Shield Bank deposits

- **Soul Power (meta):** permanent currency; spent to **unlock** discovered nodes and buy permanent starts-at-level bonuses

- **Synth Materials:** created in the **city** over **time** (and prior synth inputs). Provide ingredients for Research

- **Minerals (Gold â†’ Royal Platinum):** upgrades that **speed up** and **discount** the Synth system globally; can be transmuted using Gold + Arcana

### Research Lab System

- **Lab Level (L1â†’L8+):** journey progression that controls what **depth** of topics appear, and **capacity** (parallel slots & queue)

- **Research Title:** 1:1 with a hidden node; completing the job **reveals** the node in the tree

- **Costs:** Soul + Synth + time

---

## 17. Balancing: Math, Curves & Tables

### Offline Models

- **Model A â€” Linearâ†’Decay:** `gain = rate * min(t, 8h) + rate * decay(t-8h)` with `decay(x)=x * e^(-k x)`; `k` tuned to hit caps

- **Model B â€” Logistic Cap:** `gain = cap / (1 + e^(-a(t-b)))` minus offset to start near-linear; intuitive caps, easy tuning

- **Model C â€” Piecewise Power:** full rate to 8h; `rate * (Î”t)^Î±` for remainder (`0<Î±<1`)

### Costs & Ramps

- **Enchant level cost:** `cost(l) = base * 1.12^l` (tune base per Tier)

- **Tierâ€‘Up:** single large purchase; suggest 15â€“25Ã— last level cost

- **Enemy HP/DMG:** ward bump + micro-ramp

### Anti-cheese Measures

- Minimum session runtime before next rested grant

- Single outstanding rested

- Diminishing rested if claimed repeatedly within 24h

---

## 18. Region R01: Horizon Steppe

### Overview (2)

**Tagline:** *Where sky kisses grass and home feels near.*

**Blurb:** The innermost prairie of the Dragonlandsâ€”wide, wind-brushed fields within sight of Draconia's spires. Thermals rise warm and steady, wildflowers stripe the downs, and old waystones mark the dragon flight-paths radiating from the capital.

### Subzones & Landmarks

- **Sunwake Downs** â€” golden grasses; tutorial stretch; gentle thermals

- **Waystone Mile** â€” line of ancient stone markers; distance gates & save icons

- **Skylark Flats** â€” constant updrafts; air skirmishes feel lively but forgiving

- **Longgrass Reach** â€” rolling swales; parallax grass "wobble" subtly tests accuracy

- **Bluewind Shelf** â€” low bluff; persistent crosswind challenges projectile travel

- **Old Hoard Road** â€” caravan trail from Draconia; lore chips and small chests

- **First Horizon** â€” panoramic ridge; boss approach with skyline staging

### Plains Faction: Wind-Taken Nomads

**Vibe:** Plains megafauna and sail-kites ridden by airy revenants. They sculpt crosswinds with banners and kites, scatter dust veils, and use skyhooks/bolas to tug even dragons off-line.

### Combat Signature

- **Crosswind Control:** Temporary **wind walls** deflect some projectiles

- **Tethers & Pulls:** Skyhooks/bolas apply short **drag/slow**, nudging aim timing

- **Lane Objects:** Planted **banners**, **kites**, and **gust totems** are destructibles that buff allies until burned or overcharged

### Boss: Khagan of the Sirocco

A colossal ridge-beast draped in a canopy of war-kites and pennants.

**Phases & Mechanics:**

1. **Bannerline:** Plants three **Sirocco Standards** across the lane â†’ overlapping crosswinds

1. **Stampede Call:** Summons Dust-Mane waves; boss gains 25% damage reduction until â‰¥2 standards are destroyed

1. **Bola Tempest:** Rotating bolas create moving "no-fly" arcs

---

## 19. Premium Currency: Astral Seals

### Overview (3)

**Astral Seals** are the premium currency of Draconia Chronicles, rooted in **Draconia's cosmic lore** rather than simple wealth or ancestry.

### Lore & Mythology

- **Origin Flame:** The **First Flame** fractured, scattering into **Origin Shards**, drifting across the cosmos

- **Sealing of the Skies:** Gods bound fragments of the cosmos into radiant tokens called **Astral Seals**

- **The Comet Showers:** When comets passed Draconia, they shed **Starlit Shards** â€” radiant fragments that rained down as meteors

- **Modern Role:** Astral Seals remain both mystical relics and functional currency, petitioning the gods themselves

### Visual Identity

- **Shape:** Irregular crystalline medallions, faceted and rune-etched

- **Core Glow:** Pulsing starlight at the center, glowing brighter than the edges

- **Surface:** Arcane runes etched into the surface, shifting slowly as if alive

- **Effect:** Appears to hover, shimmering faintly with cosmic light

### Usage

- Rune Gachapon (randomized rune draws)

- Unlocking additional Rune Slots

- Unlocking additional Lab Slots

- Unlocking Lab Queues

- (Future) Cosmetic purchases

### Economy Philosophy

- **Not Pay-to-Win:** Runes and lab upgrades accelerate progress but are not required to finish the game

- **Scarcity:** Astral Seals must feel rare â€” earned slowly in-game, sparingly sold in premium bundles

- **Prestige:** Seals serve as a mark of dedication or investment, not of honor or ancestry

---

## 20. Testing, QA & CI/CD

### Testing Matrix

- **Unit:** math, RNG, ability lifecycle, offline calc

- **Integration:** simâ†’dropsâ†’Arcanaâ†’purchaseâ†’Return; Dexie save/load; stats counters

- **E2E:** Splashâ†’Nameâ†’Journeyâ†’Returnâ†’Upgrade; `/stats` export; error boundary

### CI Gates

- Typecheck, lint, unit/integration, Playwright smoke, size budgets, Lighthouse (warn/gate)

### Git Hooks

- Husky v9+, lint-staged, commitlint (conventional)

### Quality Gates

- **Unit:** Vitest for math/curves/config; property tests for offline models

- **Integration:** store interactions, worker protocol, Dexie migrations

- **E2E:** Playwright â€” UI flows, a11y focus order, fake time jumps for offline simulation

- **A11y gates:** Lighthouse **â‰¥95**; axe-core in CI for violations; reduced-motion snapshots

---

## 21. Accessibility & Mobile UX

### MVP A11y

- Visible focus rings, logical tab order, ARIA labels/roles, reduced-motion mode, **44Ã—44 targets**

- Lighthouse a11y **â‰¥95** gate when enabled

### Mobile Patterns

- Bottom sheets, FAB, big touch targets, gesture scope (scroll/zoom only)

### Controls & UX

- **Desktop:** keyboard hotkeys (phase into rebinding in 2.0), mouse clicks for abilities

- **Mobile:** bottom-sheet dialogs, **FAB** bottom-right for primary action, 44Ã—44 hit targets, pinch-zoom/scroll only for gestures

- **Logs:** **player-facing narration** and **debug logs** (dual stream); narration is a live region for a11y

### Future A11y (2.0)

- Color-blind palettes, key rebinding, gamepad/controller, screen-shake intensity slider, full captions and SFX mixing

---

## 22. Roadmap: Phases, Epics & Workpacks

### Phase 0 â€” Foundational Scaffolding & Guardrails (W1-W8)

"Less thrash, bigger chunks, green pipeline."

- âœ… **W1**: Repo & Standards (monorepo, TS strict, ESLint+Prettier, Husky v9+, commitlint, templates)

- âœ… **W2**: App Shell & Render Host (SvelteKit, Pixi mount, HUD toggle, pooling primitives)

- âœ… **W3**: Worker Sim Harness (worker protocol v1, RNG, fixed clock, offline stub, autorecover)

- âœ… **W4**: Persistence v1 (Dexie schema, Zod, atomic writes, export/import, migration scaffold)

- âœ… **W5**: Logging v1 (ring buffer caps, Dexie flush, console sink, export, perf lab)

- âœ… **W6**: PWA & Update UX (Workbox, precache, manifest/icons, service worker, offline support)

- ðŸ”„ **W7**: CI/CD & Previews (Actions, caches, size budgets, Playwright, Lighthouse, PR previews)

- â³ **W8**: Dev UX & Docs (feature flags, error boundary, ADRs, CONTRIBUTING, privacy stance)

### Phase 0 Success Criteria

Base app cold start â‰¤ 2s; bundle â‰¤ 200 KB gz; logger â‰¤ 8 KB gz; deterministic worker sim
â‰¥60fps;
Dexie
v1
+
3
profiles;
structured
logging
with
export;
PWA
install
+
update
toast
âœ…;
full
CI
pipeline
âœ….

### Phase 1 â€” Shooter-Idle Core

- Distance/Wards, Spawns/AI, Arcana/Enchants, Return, Offline/Rested, Ability-1

### Phase 2 â€” Abilities Framework & Cooldowns

- Manual dmg ~20% Â±10%; buffs/debuffs

### Phase 3 â€” Town v0

- Vendor/Kiosk; items & gold loop

### Version 1.0.0 Criteria

Complete ALL 4 phases + extended alpha development + beta phase + release candidate phase
with
all
success
criteria
met.

---

## 23. Security, Privacy & Legal

### Privacy (2)

- No PII beyond dragon name in save; telemetry local + export; opt-out for external analytics

### Security

- Content validation, Zod codecs, save import checksums, sandboxed mod API

### Legal

- **Mod policy** (Zomboid-like): rights to integrate; attribution; code of conduct

### Risks & Mitigations

- **Meta overshadowing combat** â†’ Gate meta post-chapter; hard budgets on income until Ch.1 clear

- **Offline cheese** â†’ cooldown for rested; caps; session requirement; serverless integrity (seeded RNG)

- **Mobile perf** â†’ early asset budgets; LOD sprites; optional 30 fps fallback

- **Save corruption** â†’ Zod validation; transactional writes; cloudless export/import

---

## Technical Implementation Notes

### Architecture Summary

- **Frontend:** SvelteKit + TypeScript, PixiJS render root, Svelte overlay, Web Workers (sim & telemetry)

- **Backend:** Web Workers, Dexie (IndexedDB)

- **Build:** pnpm workspaces, Vite, TypeScript project references

- **Testing:** Vitest, Playwright, custom tiny-runner

- **CI/CD:** GitHub Actions, Lighthouse CI

- **PWA:** Workbox, service workers, offline support

### Development Commands

- `pnpm run dev:web` - Start web app

- `pnpm run dev:sandbox` - Start sandbox CLI

- `pnpm run lint` - ESLint check

- `pnpm run format` - Prettier format

- `pnpm run type-check` - TypeScript check

- `pnpm run test:all` - Run all tests

- `pnpm run test:vitest` - Unit and integration tests

- `pnpm run test:e2e` - End-to-end tests

### Key Files & References

- **CLAUDE.md**: AI development guidelines and operational procedures

- **docs/engineering/**: Complete debugging chronicles and handoff documentation

- **docs/optimization/**: Code optimization guides and performance improvements

- **scripts/**: Automation scripts for repetitive tasks and maintenance

---

**End of Draconia Chronicles v2.3.1 GDD**

*This document serves as the comprehensive technical bible for the project, integrating all design decisions, technical specifications, and implementation details into a unified reference. Version 2.3.1 introduces the Arcana Expansion with persistent currency, Shield Tax system, and expanded city investment mechanics.*
