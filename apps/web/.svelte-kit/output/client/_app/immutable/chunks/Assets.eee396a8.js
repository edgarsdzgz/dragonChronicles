import{j as re,R as z,T as S,D as g,c as f,L as x,p as v,k as oe,w as y,l as B,m as Z,b as A,o as F,I as J,q as k,s as ce,e as L}from"./index.29d1603d.js";import{A as le,B as N}from"./BitmapFontManager.48d0f22b.js";import{G as de}from"./GraphicsContext.150a2426.js";class q extends le{constructor(e,s){super();const{textures:a,data:n}=e;Object.keys(n.pages).forEach(i=>{const r=n.pages[parseInt(i,10)],o=a[r.id];this.pages.push({texture:o})}),Object.keys(n.chars).forEach(i=>{const r=n.chars[i],{frame:o,source:l,rotate:c}=a[r.page],h=re.transformRectCoords(r,o,c,new z),d=new S({frame:h,orig:new z(0,0,r.width,r.height),source:l,rotate:c});this.chars[i]={id:i.codePointAt(0),xOffset:r.xOffset,yOffset:r.yOffset,xAdvance:r.xAdvance,kerning:r.kerning??{},texture:d}}),this.baseRenderedFontSize=n.fontSize,this.baseMeasurementFontSize=n.fontSize,this.fontMetrics={ascent:0,descent:0,fontSize:n.fontSize},this.baseLineOffset=n.baseLineOffset,this.lineHeight=n.lineHeight,this.fontFamily=n.fontFamily,this.distanceField=n.distanceField??{type:"none",range:0},this.url=s}destroy(){super.destroy();for(let e=0;e<this.pages.length;e++){const{texture:s}=this.pages[e];s.destroy(!0)}this.pages=null}static install(e){N.install(e)}static uninstall(e){N.uninstall(e)}}const R={test(t){return typeof t=="string"&&t.startsWith("info face=")},parse(t){const e=t.match(/^[a-z]+\s+.+$/gm),s={info:[],common:[],page:[],char:[],chars:[],kerning:[],kernings:[],distanceField:[]};for(const d in e){const p=e[d].match(/^[a-z]+/gm)[0],u=e[d].match(/[a-zA-Z]+=([^\s"']+|"([^"]*)")/gm),m={};for(const I in u){const $=u[I].split("="),ne=$[0],V=$[1].replace(/"/gm,""),D=parseFloat(V),ie=isNaN(D)?V:D;m[ne]=ie}s[p].push(m)}const a={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},[n]=s.info,[i]=s.common,[r]=s.distanceField??[];r&&(a.distanceField={range:parseInt(r.distanceRange,10),type:r.fieldType}),a.fontSize=parseInt(n.size,10),a.fontFamily=n.face,a.lineHeight=parseInt(i.lineHeight,10);const o=s.page;for(let d=0;d<o.length;d++)a.pages.push({id:parseInt(o[d].id,10)||0,file:o[d].file});const l={};a.baseLineOffset=a.lineHeight-parseInt(i.base,10);const c=s.char;for(let d=0;d<c.length;d++){const p=c[d],u=parseInt(p.id,10);let m=p.letter??p.char??String.fromCharCode(u);m==="space"&&(m=" "),l[u]=m,a.chars[m]={id:u,page:parseInt(p.page,10)||0,x:parseInt(p.x,10),y:parseInt(p.y,10),width:parseInt(p.width,10),height:parseInt(p.height,10),xOffset:parseInt(p.xoffset,10),yOffset:parseInt(p.yoffset,10),xAdvance:parseInt(p.xadvance,10),kerning:{}}}const h=s.kerning||[];for(let d=0;d<h.length;d++){const p=parseInt(h[d].first,10),u=parseInt(h[d].second,10),m=parseInt(h[d].amount,10);a.chars[l[u]].kerning[l[p]]=m}return a}},G={test(t){const e=t;return typeof e!="string"&&"getElementsByTagName"in e&&e.getElementsByTagName("page").length&&e.getElementsByTagName("info")[0].getAttribute("face")!==null},parse(t){const e={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},s=t.getElementsByTagName("info")[0],a=t.getElementsByTagName("common")[0],n=t.getElementsByTagName("distanceField")[0];n&&(e.distanceField={type:n.getAttribute("fieldType"),range:parseInt(n.getAttribute("distanceRange"),10)});const i=t.getElementsByTagName("page"),r=t.getElementsByTagName("char"),o=t.getElementsByTagName("kerning");e.fontSize=parseInt(s.getAttribute("size"),10),e.fontFamily=s.getAttribute("face"),e.lineHeight=parseInt(a.getAttribute("lineHeight"),10);for(let c=0;c<i.length;c++)e.pages.push({id:parseInt(i[c].getAttribute("id"),10)||0,file:i[c].getAttribute("file")});const l={};e.baseLineOffset=e.lineHeight-parseInt(a.getAttribute("base"),10);for(let c=0;c<r.length;c++){const h=r[c],d=parseInt(h.getAttribute("id"),10);let p=h.getAttribute("letter")??h.getAttribute("char")??String.fromCharCode(d);p==="space"&&(p=" "),l[d]=p,e.chars[p]={id:d,page:parseInt(h.getAttribute("page"),10)||0,x:parseInt(h.getAttribute("x"),10),y:parseInt(h.getAttribute("y"),10),width:parseInt(h.getAttribute("width"),10),height:parseInt(h.getAttribute("height"),10),xOffset:parseInt(h.getAttribute("xoffset"),10),yOffset:parseInt(h.getAttribute("yoffset"),10),xAdvance:parseInt(h.getAttribute("xadvance"),10),kerning:{}}}for(let c=0;c<o.length;c++){const h=parseInt(o[c].getAttribute("first"),10),d=parseInt(o[c].getAttribute("second"),10),p=parseInt(o[c].getAttribute("amount"),10);e.chars[l[d]].kerning[l[h]]=p}return e}},H={test(t){return typeof t=="string"&&t.includes("<font>")?G.test(g.get().parseXML(t)):!1},parse(t){return G.parse(g.get().parseXML(t))}},he=[".xml",".fnt"],pe={extension:{type:f.CacheParser,name:"cacheBitmapFont"},test:t=>t instanceof q,getCacheableAssets(t,e){const s={};return t.forEach(a=>{s[a]=e,s[`${a}-bitmap`]=e}),s[`${e.fontFamily}-bitmap`]=e,s}},fe={extension:{type:f.LoadParser,priority:x.Normal},name:"loadBitmapFont",id:"bitmap-font",test(t){return he.includes(v.extname(t).toLowerCase())},async testParse(t){return R.test(t)||H.test(t)},async parse(t,e,s){const a=R.test(t)?R.parse(t):H.parse(t),{src:n}=e,{pages:i}=a,r=[],o=a.distanceField?{scaleMode:"linear",alphaMode:"premultiply-alpha-on-upload",autoGenerateMipmaps:!1,resolution:1}:{};for(let d=0;d<i.length;++d){const p=i[d].file;let u=v.join(v.dirname(n),p);u=oe(u,n),r.push({src:u,data:o})}const l=await s.load(r),c=r.map(d=>l[d.src]);return new q({data:a,textures:c},n)},async load(t,e){return await(await g.get().fetch(t)).text()},async unload(t,e,s){await Promise.all(t.pages.map(a=>s.unload(a.texture.source._sourceOrigin))),t.destroy()}};class ue{constructor(e,s=!1){this._loader=e,this._assetList=[],this._isLoading=!1,this._maxConcurrent=1,this.verbose=s}add(e){e.forEach(s=>{this._assetList.push(s)}),this.verbose&&console.log("[BackgroundLoader] assets: ",this._assetList),this._isActive&&!this._isLoading&&this._next()}async _next(){if(this._assetList.length&&this._isActive){this._isLoading=!0;const e=[],s=Math.min(this._assetList.length,this._maxConcurrent);for(let a=0;a<s;a++)e.push(this._assetList.pop());await this._loader.load(e),this._isLoading=!1,this._next()}}get active(){return this._isActive}set active(e){this._isActive!==e&&(this._isActive=e,e&&!this._isLoading&&this._next())}}const me={extension:{type:f.CacheParser,name:"cacheTextureArray"},test:t=>Array.isArray(t)&&t.every(e=>e instanceof S),getCacheableAssets:(t,e)=>{const s={};return t.forEach(a=>{e.forEach((n,i)=>{s[a+(i===0?"":i+1)]=n})}),s}};async function ee(t){if("Image"in globalThis)return new Promise(e=>{const s=new Image;s.onload=()=>{e(!0)},s.onerror=()=>{e(!1)},s.src=t});if("createImageBitmap"in globalThis&&"fetch"in globalThis){try{const e=await(await fetch(t)).blob();await createImageBitmap(e)}catch{return!1}return!0}return!1}const ge={extension:{type:f.DetectionParser,priority:1},test:async()=>ee("data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A="),add:async t=>[...t,"avif"],remove:async t=>t.filter(e=>e!=="avif")},X=["png","jpg","jpeg"],Ae={extension:{type:f.DetectionParser,priority:-1},test:()=>Promise.resolve(!0),add:async t=>[...t,...X],remove:async t=>t.filter(e=>!X.includes(e))},ye="WorkerGlobalScope"in globalThis&&globalThis instanceof globalThis.WorkerGlobalScope;function O(t){return ye?!1:document.createElement("video").canPlayType(t)!==""}const ve={extension:{type:f.DetectionParser,priority:0},test:async()=>O("video/mp4"),add:async t=>[...t,"mp4","m4v"],remove:async t=>t.filter(e=>e!=="mp4"&&e!=="m4v")},we={extension:{type:f.DetectionParser,priority:0},test:async()=>O("video/ogg"),add:async t=>[...t,"ogv"],remove:async t=>t.filter(e=>e!=="ogv")},be={extension:{type:f.DetectionParser,priority:0},test:async()=>O("video/webm"),add:async t=>[...t,"webm"],remove:async t=>t.filter(e=>e!=="webm")},xe={extension:{type:f.DetectionParser,priority:0},test:async()=>ee("data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA="),add:async t=>[...t,"webp"],remove:async t=>t.filter(e=>e!=="webp")};class _e{constructor(){this._parsers=[],this._parsersValidated=!1,this.parsers=new Proxy(this._parsers,{set:(e,s,a)=>(this._parsersValidated=!1,e[s]=a,!0)}),this.promiseCache={}}reset(){this._parsersValidated=!1,this.promiseCache={}}_getLoadPromiseAndParser(e,s){const a={promise:null,parser:null};return a.promise=(async()=>{let n=null,i=null;if((s.parser||s.loadParser)&&(i=this._parserHash[s.parser||s.loadParser],s.loadParser&&y(`[Assets] "loadParser" is deprecated, use "parser" instead for ${e}`),i||y(`[Assets] specified load parser "${s.parser||s.loadParser}" not found while loading ${e}`)),!i){for(let r=0;r<this.parsers.length;r++){const o=this.parsers[r];if(o.load&&o.test?.(e,s,this)){i=o;break}}if(!i)return y(`[Assets] ${e} could not be loaded as we don't know how to parse it, ensure the correct parser has been added`),null}n=await i.load(e,s,this),a.parser=i;for(let r=0;r<this.parsers.length;r++){const o=this.parsers[r];o.parse&&o.parse&&await o.testParse?.(n,s,this)&&(n=await o.parse(n,s,this)||n,a.parser=o)}return n})(),a}async load(e,s){this._parsersValidated||this._validateParsers();let a=0;const n={},i=Z(e),r=B(e,c=>({alias:[c],src:c,data:{}})),o=r.length,l=r.map(async c=>{const h=v.toAbsolute(c.src);if(!n[c.src])try{this.promiseCache[h]||(this.promiseCache[h]=this._getLoadPromiseAndParser(h,c)),n[c.src]=await this.promiseCache[h].promise,s&&s(++a/o)}catch(d){throw delete this.promiseCache[h],delete n[c.src],new Error(`[Loader.load] Failed to load ${h}.
${d}`)}});return await Promise.all(l),i?n[r[0].src]:n}async unload(e){const a=B(e,n=>({alias:[n],src:n})).map(async n=>{const i=v.toAbsolute(n.src),r=this.promiseCache[i];if(r){const o=await r.promise;delete this.promiseCache[i],await r.parser?.unload?.(o,n,this)}});await Promise.all(a)}_validateParsers(){this._parsersValidated=!0,this._parserHash=this._parsers.filter(e=>e.name||e.id).reduce((e,s)=>(!s.name&&!s.id?y("[Assets] parser should have an id"):(e[s.name]||e[s.id])&&y(`[Assets] parser id conflict "${s.id}"`),e[s.name]=s,s.id&&(e[s.id]=s),e),{})}}function _(t,e){if(Array.isArray(e)){for(const s of e)if(t.startsWith(`data:${s}`))return!0;return!1}return t.startsWith(`data:${e}`)}function E(t,e){const s=t.split("?")[0],a=v.extname(s).toLowerCase();return Array.isArray(e)?e.includes(a):a===e}const Ee=".json",Ie="application/json",Be={extension:{type:f.LoadParser,priority:x.Low},name:"loadJson",id:"json",test(t){return _(t,Ie)||E(t,Ee)},async load(t){return await(await g.get().fetch(t)).json()}},Le=".txt",Pe="text/plain",ke={name:"loadTxt",id:"text",extension:{type:f.LoadParser,priority:x.Low,name:"loadTxt"},test(t){return _(t,Pe)||E(t,Le)},async load(t){return await(await g.get().fetch(t)).text()}},Fe=["normal","bold","100","200","300","400","500","600","700","800","900"],Oe=[".ttf",".otf",".woff",".woff2"],Re=["font/ttf","font/otf","font/woff","font/woff2"],Te=/^(--|-?[A-Z_])[0-9A-Z_-]*$/i;function Ce(t){const e=v.extname(t),n=v.basename(t,e).replace(/(-|_)/g," ").toLowerCase().split(" ").map(o=>o.charAt(0).toUpperCase()+o.slice(1));let i=n.length>0;for(const o of n)if(!o.match(Te)){i=!1;break}let r=n.join(" ");return i||(r=`"${r.replace(/[\\"]/g,"\\$&")}"`),r}const Me=/^[0-9A-Za-z%:/?#\[\]@!\$&'()\*\+,;=\-._~]*$/;function We(t){return Me.test(t)?t:encodeURI(t)}const Se={extension:{type:f.LoadParser,priority:x.Low},name:"loadWebFont",id:"web-font",test(t){return _(t,Re)||E(t,Oe)},async load(t,e){const s=g.get().getFontFaceSet();if(s){const a=[],n=e.data?.family??Ce(t),i=e.data?.weights?.filter(o=>Fe.includes(o))??["normal"],r=e.data??{};for(let o=0;o<i.length;o++){const l=i[o],c=new FontFace(n,`url(${We(t)})`,{...r,weight:l});await c.load(),s.add(c),a.push(c)}return A.has(`${n}-and-url`)?A.get(`${n}-and-url`).entries.push({url:t,faces:a}):A.set(`${n}-and-url`,{entries:[{url:t,faces:a}]}),a.length===1?a[0]:a}return y("[loadWebFont] FontFace API is not supported. Skipping loading font"),null},unload(t){const e=Array.isArray(t)?t:[t],s=e[0].family,a=A.get(`${s}-and-url`),n=a.entries.find(i=>i.faces.some(r=>e.indexOf(r)!==-1));n.faces=n.faces.filter(i=>e.indexOf(i)===-1),n.faces.length===0&&(a.entries=a.entries.filter(i=>i!==n)),e.forEach(i=>{g.get().getFontFaceSet().delete(i)}),a.entries.length===0&&A.remove(`${s}-and-url`)}};function j(t,e=1){const s=F.RETINA_PREFIX?.exec(t);return s?parseFloat(s[1]):e}function U(t,e,s){t.label=s,t._sourceOrigin=s;const a=new S({source:t,label:s}),n=()=>{delete e.promiseCache[s],A.has(s)&&A.remove(s)};return a.source.once("destroy",()=>{e.promiseCache[s]&&(y("[Assets] A TextureSource managed by Assets was destroyed instead of unloaded! Use Assets.unload() instead of destroying the TextureSource."),n())}),a.once("destroy",()=>{t.destroyed||(y("[Assets] A Texture managed by Assets was destroyed instead of unloaded! Use Assets.unload() instead of destroying the Texture."),n())}),a}const je=".svg",Ue="image/svg+xml",$e={extension:{type:f.LoadParser,priority:x.Low,name:"loadSVG"},name:"loadSVG",id:"svg",config:{crossOrigin:"anonymous",parseAsGraphicsContext:!1},test(t){return _(t,Ue)||E(t,je)},async load(t,e,s){return e.data?.parseAsGraphicsContext??this.config.parseAsGraphicsContext?De(t):Ve(t,e,s,this.config.crossOrigin)},unload(t){t.destroy(!0)}};async function Ve(t,e,s,a){const n=await g.get().fetch(t),i=g.get().createImage();i.src=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(await n.text())}`,i.crossOrigin=a,await i.decode();const r=e.data?.width??i.width,o=e.data?.height??i.height,l=e.data?.resolution||j(t),c=Math.ceil(r*l),h=Math.ceil(o*l),d=g.get().createCanvas(c,h),p=d.getContext("2d");p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high",p.drawImage(i,0,0,r*l,o*l);const{parseAsGraphicsContext:u,...m}=e.data??{},I=new J({resource:d,alphaMode:"premultiply-alpha-on-upload",resolution:l,...m});return U(I,s,t)}async function De(t){const s=await(await g.get().fetch(t)).text(),a=new de;return a.svg(s),a}const ze=`(function () {
    'use strict';

    const WHITE_PNG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";
    async function checkImageBitmap() {
      try {
        if (typeof createImageBitmap !== "function")
          return false;
        const response = await fetch(WHITE_PNG);
        const imageBlob = await response.blob();
        const imageBitmap = await createImageBitmap(imageBlob);
        return imageBitmap.width === 1 && imageBitmap.height === 1;
      } catch (_e) {
        return false;
      }
    }
    void checkImageBitmap().then((result) => {
      self.postMessage(result);
    });

})();
`;let w=null,W=class{constructor(){w||(w=URL.createObjectURL(new Blob([ze],{type:"application/javascript"}))),this.worker=new Worker(w)}};W.revokeObjectURL=function(){w&&(URL.revokeObjectURL(w),w=null)};const Ne=`(function () {
    'use strict';

    async function loadImageBitmap(url, alphaMode) {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(\`[WorkerManager.loadImageBitmap] Failed to fetch \${url}: \${response.status} \${response.statusText}\`);
      }
      const imageBlob = await response.blob();
      return alphaMode === "premultiplied-alpha" ? createImageBitmap(imageBlob, { premultiplyAlpha: "none" }) : createImageBitmap(imageBlob);
    }
    self.onmessage = async (event) => {
      try {
        const imageBitmap = await loadImageBitmap(event.data.data[0], event.data.data[1]);
        self.postMessage({
          data: imageBitmap,
          uuid: event.data.uuid,
          id: event.data.id
        }, [imageBitmap]);
      } catch (e) {
        self.postMessage({
          error: e,
          uuid: event.data.uuid,
          id: event.data.id
        });
      }
    };

})();
`;let b=null;class te{constructor(){b||(b=URL.createObjectURL(new Blob([Ne],{type:"application/javascript"}))),this.worker=new Worker(b)}}te.revokeObjectURL=function(){b&&(URL.revokeObjectURL(b),b=null)};let K=0,T;class Ge{constructor(){this._initialized=!1,this._createdWorkers=0,this._workerPool=[],this._queue=[],this._resolveHash={}}isImageBitmapSupported(){return this._isImageBitmapSupported!==void 0?this._isImageBitmapSupported:(this._isImageBitmapSupported=new Promise(e=>{const{worker:s}=new W;s.addEventListener("message",a=>{s.terminate(),W.revokeObjectURL(),e(a.data)})}),this._isImageBitmapSupported)}loadImageBitmap(e,s){return this._run("loadImageBitmap",[e,s?.data?.alphaMode])}async _initWorkers(){this._initialized||(this._initialized=!0)}_getWorker(){T===void 0&&(T=navigator.hardwareConcurrency||4);let e=this._workerPool.pop();return!e&&this._createdWorkers<T&&(this._createdWorkers++,e=new te().worker,e.addEventListener("message",s=>{this._complete(s.data),this._returnWorker(s.target),this._next()})),e}_returnWorker(e){this._workerPool.push(e)}_complete(e){e.error!==void 0?this._resolveHash[e.uuid].reject(e.error):this._resolveHash[e.uuid].resolve(e.data),this._resolveHash[e.uuid]=null}async _run(e,s){await this._initWorkers();const a=new Promise((n,i)=>{this._queue.push({id:e,arguments:s,resolve:n,reject:i})});return this._next(),a}_next(){if(!this._queue.length)return;const e=this._getWorker();if(!e)return;const s=this._queue.pop(),a=s.id;this._resolveHash[K]={resolve:s.resolve,reject:s.reject},e.postMessage({data:s.arguments,uuid:K++,id:a})}reset(){this._workerPool.forEach(e=>e.terminate()),this._workerPool.length=0,Object.values(this._resolveHash).forEach(({reject:e})=>{e?.(new Error("WorkerManager destroyed"))}),this._resolveHash={},this._queue.length=0,this._initialized=!1,this._createdWorkers=0}}const Q=new Ge,He=[".jpeg",".jpg",".png",".webp",".avif"],Xe=["image/jpeg","image/png","image/webp","image/avif"];async function Ke(t,e){const s=await g.get().fetch(t);if(!s.ok)throw new Error(`[loadImageBitmap] Failed to fetch ${t}: ${s.status} ${s.statusText}`);const a=await s.blob();return e?.data?.alphaMode==="premultiplied-alpha"?createImageBitmap(a,{premultiplyAlpha:"none"}):createImageBitmap(a)}const se={name:"loadTextures",id:"texture",extension:{type:f.LoadParser,priority:x.High,name:"loadTextures"},config:{preferWorkers:!0,preferCreateImageBitmap:!0,crossOrigin:"anonymous"},test(t){return _(t,Xe)||E(t,He)},async load(t,e,s){let a=null;globalThis.createImageBitmap&&this.config.preferCreateImageBitmap?this.config.preferWorkers&&await Q.isImageBitmapSupported()?a=await Q.loadImageBitmap(t,e):a=await Ke(t,e):a=await new Promise((i,r)=>{a=g.get().createImage(),a.crossOrigin=this.config.crossOrigin,a.src=t,a.complete?i(a):(a.onload=()=>{i(a)},a.onerror=r)});const n=new J({resource:a,alphaMode:"premultiply-alpha-on-upload",resolution:e.data?.resolution||j(t),...e.data});return U(n,s,t)},unload(t){t.destroy(!0)}},Qe=[".mp4",".m4v",".webm",".ogg",".ogv",".h264",".avi",".mov"];let C,M;function Ye(t,e,s){s===void 0&&!e.startsWith("data:")?t.crossOrigin=Je(e):s!==!1&&(t.crossOrigin=typeof s=="string"?s:"anonymous")}function Ze(t){return new Promise((e,s)=>{t.addEventListener("canplaythrough",a),t.addEventListener("error",n),t.load();function a(){i(),e()}function n(r){i(),s(r)}function i(){t.removeEventListener("canplaythrough",a),t.removeEventListener("error",n)}})}function Je(t,e=globalThis.location){if(t.startsWith("data:"))return"";e||(e=globalThis.location);const s=new URL(t,document.baseURI);return s.hostname!==e.hostname||s.port!==e.port||s.protocol!==e.protocol?"anonymous":""}function qe(){const t=[],e=[];for(const s of Qe){const a=k.MIME_TYPES[s.substring(1)]||`video/${s.substring(1)}`;O(a)&&(t.push(s),e.includes(a)||e.push(a))}return{validVideoExtensions:t,validVideoMime:e}}const et={name:"loadVideo",id:"video",extension:{type:f.LoadParser,name:"loadVideo"},test(t){if(!C||!M){const{validVideoExtensions:a,validVideoMime:n}=qe();C=a,M=n}const e=_(t,M),s=E(t,C);return e||s},async load(t,e,s){const a={...k.defaultOptions,resolution:e.data?.resolution||j(t),alphaMode:e.data?.alphaMode||await ce(),...e.data},n=document.createElement("video"),i={preload:a.autoLoad!==!1?"auto":void 0,"webkit-playsinline":a.playsinline!==!1?"":void 0,playsinline:a.playsinline!==!1?"":void 0,muted:a.muted===!0?"":void 0,loop:a.loop===!0?"":void 0,autoplay:a.autoPlay!==!1?"":void 0};Object.keys(i).forEach(l=>{const c=i[l];c!==void 0&&n.setAttribute(l,c)}),a.muted===!0&&(n.muted=!0),Ye(n,t,a.crossorigin);const r=document.createElement("source");let o;if(a.mime)o=a.mime;else if(t.startsWith("data:"))o=t.slice(5,t.indexOf(";"));else if(!t.startsWith("blob:")){const l=t.split("?")[0].slice(t.lastIndexOf(".")+1).toLowerCase();o=k.MIME_TYPES[l]||`video/${l}`}return r.src=t,o&&(r.type=o),new Promise(l=>{const c=async()=>{const h=new k({...a,resource:n});n.removeEventListener("canplay",c),e.data.preload&&await Ze(n),l(U(h,s,t))};a.preload&&!a.autoPlay&&n.load(),n.addEventListener("canplay",c),n.appendChild(r)})},unload(t){t.destroy(!0)}},ae={extension:{type:f.ResolveParser,name:"resolveTexture"},test:se.test,parse:t=>({resolution:parseFloat(F.RETINA_PREFIX.exec(t)?.[1]??"1"),format:t.split(".").pop(),src:t})},tt={extension:{type:f.ResolveParser,priority:-2,name:"resolveJson"},test:t=>F.RETINA_PREFIX.test(t)&&t.endsWith(".json"),parse:ae.parse};class st{constructor(){this._detections=[],this._initialized=!1,this.resolver=new F,this.loader=new _e,this.cache=A,this._backgroundLoader=new ue(this.loader),this._backgroundLoader.active=!0,this.reset()}async init(e={}){if(this._initialized){y("[Assets]AssetManager already initialized, did you load before calling this Assets.init()?");return}if(this._initialized=!0,e.defaultSearchParams&&this.resolver.setDefaultSearchParams(e.defaultSearchParams),e.basePath&&(this.resolver.basePath=e.basePath),e.bundleIdentifier&&this.resolver.setBundleIdentifier(e.bundleIdentifier),e.manifest){let i=e.manifest;typeof i=="string"&&(i=await this.load(i)),this.resolver.addManifest(i)}const s=e.texturePreference?.resolution??1,a=typeof s=="number"?[s]:s,n=await this._detectFormats({preferredFormats:e.texturePreference?.format,skipDetections:e.skipDetections,detections:this._detections});this.resolver.prefer({params:{format:n,resolution:a}}),e.preferences&&this.setPreferences(e.preferences)}add(e){this.resolver.add(e)}async load(e,s){this._initialized||await this.init();const a=Z(e),n=B(e).map(o=>{if(typeof o!="string"){const l=this.resolver.getAlias(o);return l.some(c=>!this.resolver.hasKey(c))&&this.add(o),Array.isArray(l)?l[0]:l}return this.resolver.hasKey(o)||this.add({alias:o,src:o}),o}),i=this.resolver.resolve(n),r=await this._mapLoadToResolve(i,s);return a?r[n[0]]:r}addBundle(e,s){this.resolver.addBundle(e,s)}async loadBundle(e,s){this._initialized||await this.init();let a=!1;typeof e=="string"&&(a=!0,e=[e]);const n=this.resolver.resolveBundle(e),i={},r=Object.keys(n);let o=0,l=0;const c=()=>{s?.(++o/l)},h=r.map(d=>{const p=n[d],u=Object.values(p),m=[...new Set(u.flat())];return l+=m.length,this._mapLoadToResolve(p,c).then(I=>{i[d]=I})});return await Promise.all(h),a?i[e[0]]:i}async backgroundLoad(e){this._initialized||await this.init(),typeof e=="string"&&(e=[e]);const s=this.resolver.resolve(e);this._backgroundLoader.add(Object.values(s))}async backgroundLoadBundle(e){this._initialized||await this.init(),typeof e=="string"&&(e=[e]);const s=this.resolver.resolveBundle(e);Object.values(s).forEach(a=>{this._backgroundLoader.add(Object.values(a))})}reset(){this.resolver.reset(),this.loader.reset(),this.cache.reset(),this._initialized=!1}get(e){if(typeof e=="string")return A.get(e);const s={};for(let a=0;a<e.length;a++)s[a]=A.get(e[a]);return s}async _mapLoadToResolve(e,s){const a=[...new Set(Object.values(e))];this._backgroundLoader.active=!1;const n=await this.loader.load(a,s);this._backgroundLoader.active=!0;const i={};return a.forEach(r=>{const o=n[r.src],l=[r.src];r.alias&&l.push(...r.alias),l.forEach(c=>{i[c]=o}),A.set(l,o)}),i}async unload(e){this._initialized||await this.init();const s=B(e).map(n=>typeof n!="string"?n.src:n),a=this.resolver.resolve(s);await this._unloadFromResolved(a)}async unloadBundle(e){this._initialized||await this.init(),e=B(e);const s=this.resolver.resolveBundle(e),a=Object.keys(s).map(n=>this._unloadFromResolved(s[n]));await Promise.all(a)}async _unloadFromResolved(e){const s=Object.values(e);s.forEach(a=>{A.remove(a.src)}),await this.loader.unload(s)}async _detectFormats(e){let s=[];e.preferredFormats&&(s=Array.isArray(e.preferredFormats)?e.preferredFormats:[e.preferredFormats]);for(const a of e.detections)e.skipDetections||await a.test()?s=await a.add(s):e.skipDetections||(s=await a.remove(s));return s=s.filter((a,n)=>s.indexOf(a)===n),s}get detections(){return this._detections}setPreferences(e){this.loader.parsers.forEach(s=>{s.config&&Object.keys(s.config).filter(a=>a in e).forEach(a=>{s.config[a]=e[a]})})}}const P=new st;L.handleByList(f.LoadParser,P.loader.parsers).handleByList(f.ResolveParser,P.resolver.parsers).handleByList(f.CacheParser,P.cache.parsers).handleByList(f.DetectionParser,P.detections);L.add(me,Ae,ge,xe,ve,we,be,Be,ke,Se,$e,se,et,fe,pe,ae,tt);const Y={loader:f.LoadParser,resolver:f.ResolveParser,cache:f.CacheParser,detection:f.DetectionParser};L.handle(f.Asset,t=>{const e=t.ref;Object.entries(Y).filter(([s])=>!!e[s]).forEach(([s,a])=>L.add(Object.assign(e[s],{extension:e[s].extension??a})))},t=>{const e=t.ref;Object.keys(Y).filter(s=>!!e[s]).forEach(s=>L.remove(e[s]))});export{P as A};
