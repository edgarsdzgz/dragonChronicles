<!-- markdownlint-disable -->

# ADR 0007: PWA Implementation

**Date**: 2025-09-06  
**Status**: Accepted

## Context

Draconia Chronicles requires a modern web application experience that can compete with native applications. The requirements include:

- **App Installation**: Users can install the game as a native-like app
- **Offline Functionality**: Game continues to work without network connectivity
- **Update Management**: Seamless updates with user control
- **Performance**: Fast loading and smooth user experience
- **Cross-Platform**: Works on desktop and mobile devices
- **App Store Alternative**: Bypass app store restrictions and fees
- **Native Integration**: Access to device features and capabilities

The game is designed as an idle shooter with offline simulation capabilities, making it an ideal candidate for PWA implementation.

## Decision

Implement a **Progressive Web App (PWA)** using Workbox for service worker management, comprehensive offline support, and seamless update experiences.

### PWA Architecture

```
PWA Components
├── Service Worker (Workbox)
│   ├── Precaching
│   ├── Runtime Caching
│   └── Update Management
├── Web App Manifest
│   ├── App Metadata
│   ├── Icons & Display
│   └── Installation Criteria
├── Offline Support
│   ├── Asset Caching
│   ├── Game Simulation
│   └── Data Persistence
└── Update System
    ├── Update Detection
    ├── User Notifications
    └── Controlled Updates
```

### Core Components

#### **Service Worker with Workbox**

```typescript
// sw.js - Workbox-based service worker
import { precacheAndRoute, createHandlerBoundToURL } from 'workbox-precaching';
import { registerRoute, NavigationRoute } from 'workbox-routing';
import { StaleWhileRevalidate, CacheFirst } from 'workbox-strategies';

// Precache core assets
precacheAndRoute(self.__WB_MANIFEST);

// Handle navigation
registerRoute(new NavigationRoute(createHandlerBoundToURL('/index.html')));

// Cache strategies for different asset types
registerRoute(
  ({ request }) => request.destination === 'image',
  new CacheFirst({ cacheName: 'images' }),
);

registerRoute(
  ({ request }) => request.destination === 'script',
  new StaleWhileRevalidate({ cacheName: 'scripts' }),
);
```

#### **Web App Manifest**

```json
{
  "name": "Draconia Chronicles",
  "short_name": "Draconia",
  "description": "Idle dragon shooter with offline simulation",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#1a1a1a",
  "theme_color": "#4a90e2",
  "orientation": "landscape-primary",
  "scope": "/",
  "lang": "en",
  "categories": ["games", "entertainment"],
  "icons": [
    {
      "src": "/icons/icon-72.png",
      "sizes": "72x72",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/icons/icon-512-maskable.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable"
    }
  ]
}
```

#### **Update Management System**

```typescript
// update-manager.ts - Update detection and control
export class UpdateManager {
  private swRegistration: ServiceWorkerRegistration | null = null;
  private updateAvailable = false;

  async initialize(): Promise<void> {
    if ('serviceWorker' in navigator) {
      this.swRegistration = await navigator.serviceWorker.register('/sw.js');
      this.setupUpdateListeners();
    }
  }

  private setupUpdateListeners(): void {
    if (this.swRegistration) {
      this.swRegistration.addEventListener('updatefound', () => {
        this.updateAvailable = true;
        this.notifyUpdateAvailable();
      });
    }
  }

  async checkForUpdates(): Promise<boolean> {
    if (!this.swRegistration) return false;

    await this.swRegistration.update();
    return this.hasWaitingWorker();
  }

  async applyUpdate(): Promise<void> {
    if (this.swRegistration?.waiting) {
      this.swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
      window.location.reload();
    }
  }
}
```

### Key Features

#### **Offline Functionality**

- **Asset Caching**: Core game assets cached for offline use
- **Game Simulation**: Worker-based simulation continues offline
- **Data Persistence**: Local storage maintains game state
- **Graceful Degradation**: Fallbacks for network-dependent features

#### **Installation Experience**

```typescript
// InstallPrompt.svelte - PWA installation prompt
export class InstallPrompt {
  private deferredPrompt: BeforeInstallPromptEvent | null = null;

  async showInstallPrompt(): Promise<void> {
    if (this.deferredPrompt) {
      this.deferredPrompt.prompt();
      const { outcome } = await this.deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        console.log('PWA installed successfully');
      }

      this.deferredPrompt = null;
    }
  }

  private setupInstallListener(): void {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      this.deferredPrompt = e;
      this.showInstallButton();
    });
  }
}
```

#### **Performance Optimization**

- **Precaching**: Critical assets cached on first visit
- **Runtime Caching**: Dynamic content cached as needed
- **Cache Strategies**: Optimized caching for different asset types
- **Bundle Optimization**: Minimal impact on bundle size

### Performance Characteristics

#### **Bundle Size Impact**

- **Base App**: ≤200 KB gzipped (maintained)
- **PWA Features**: <5% increase in bundle size
- **Service Worker**: ~50 KB (cached separately)
- **Manifest**: <1 KB

#### **Performance Benchmarks**

- **PWA Installation**: <5 seconds
- **Service Worker Registration**: <2 seconds
- **Offline Functionality**: Maintains 60fps simulation
- **Update Flow**: <3 seconds for update detection
- **Cache Hit Rate**: >90% for core assets

### Offline Support

#### **Caching Strategies**

```typescript
// Different caching strategies for different content types
const cacheStrategies = {
  // Static assets - cache first
  images: new CacheFirst({
    cacheName: 'images',
    plugins: [
      {
        cacheKeyWillBeUsed: async ({ request }) => {
          return `${request.url}?v=${CACHE_VERSION}`;
        },
      },
    ],
  }),

  // Dynamic content - stale while revalidate
  api: new StaleWhileRevalidate({
    cacheName: 'api',
    plugins: [
      {
        cacheWillUpdate: async ({ response }) => {
          return response.status === 200 ? response : null;
        },
      },
    ],
  }),

  // Navigation - network first
  navigation: new NetworkFirst({
    cacheName: 'navigation',
    plugins: [
      {
        cacheWillUpdate: async ({ response }) => {
          return response.status === 200 ? response : null;
        },
      },
    ],
  }),
};
```

#### **Offline Game Simulation**

- **Worker Continuation**: Simulation worker continues offline
- **State Persistence**: Game state saved locally
- **Progress Tracking**: Offline progress maintained
- **Sync on Reconnect**: Data synchronization when online

## Consequences

### Positive

- **Native App Experience**: App-like experience without app store
- **Offline Functionality**: Game works without network connectivity
- **Fast Loading**: Cached assets provide instant loading
- **Update Control**: Users control when updates are applied
- **Cross-Platform**: Works on all modern browsers and devices
- **No App Store Fees**: Bypass app store restrictions and costs
- **Easy Distribution**: Simple URL sharing and installation

### Negative

- **Browser Dependency**: Requires modern browser with PWA support
- **Storage Limitations**: Subject to browser storage quotas
- **Update Complexity**: More complex update management than native apps
- **Feature Limitations**: Some native features may not be available
- **User Education**: Users need to understand PWA installation

### Operational Impact

- **Development Workflow**:
  - Service worker development and testing
  - PWA manifest maintenance
  - Icon generation and optimization
  - Update flow testing

- **Testing Strategy**:
  - Cross-browser PWA testing
  - Offline functionality testing
  - Installation flow testing
  - Update mechanism testing

- **Deployment**:
  - Service worker deployment
  - Manifest updates
  - Icon updates
  - Cache invalidation

### Integration Points

#### **Worker Simulation (W3)**

- Service worker coordinates with simulation worker
- Offline simulation continues during network outages
- State synchronization between workers

#### **Database Layer (W4)**

- Local storage persists across service worker updates
- Offline data operations continue seamlessly
- Data integrity maintained during updates

#### **Logging System (W5)**

- Logs persist across service worker updates
- Offline logging and analysis
- Performance monitoring for PWA features

### Migration Path

The PWA implementation was established during W6 and has proven successful:

1. **W6**: Core PWA implementation with Workbox and offline support
2. **W7**: CI/CD integration and deployment automation
3. **W8**: Error boundary integration and user experience improvements
4. **Future**: Advanced PWA features and native integration

### Future Enhancements

- **Background Sync**: Sync data when network becomes available
- **Push Notifications**: Notify users of game events
- **Native Integration**: Access to device features and capabilities
- **Advanced Caching**: Intelligent caching based on usage patterns
- **Performance Monitoring**: PWA-specific performance metrics

## References

- [Workbox Documentation](https://developers.google.com/web/tools/workbox)
- [PWA Builder](https://www.pwabuilder.com/)
- [MDN PWA Guide](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps)
- [W6 Implementation](../engineering/pwa-implementation.md)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
